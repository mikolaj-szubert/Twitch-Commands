document.addEventListener("DOMContentLoaded",async()=>{let e=()=>new Promise((e,t)=>{chrome.tabs.query({active:!0,lastFocusedWindow:!0},a=>{if(a&&a.length>0){let n=a[0].url,s=new URL(n).pathname.split("/")[1];n.includes("twitch.tv")||chrome.tabs.create({url:"https://www.twitch.tv/"}),e(s)}else console.error("Nie można uzyskać informacji o aktualnej karcie."),t("Nie można uzyskać informacji o aktualnej karcie.")})}),t,a=await e(),n=`https://api.streamelements.com/kappa/v2/channels/${a}`,s=async()=>fetch(n,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>{if(e.ok)return e.json()}).then(e=>e._id).catch(e=>(console.warn("Error while getting streamer id: ",e),"")),i=await s(),l=`https://api.streamelements.com/kappa/v2/bot/commands/${i}`,o=`https://api.streamelements.com/kappa/v2/bot/commands/${i}/default`,r=`https://api.streamelements.com/kappa/v2/songrequest/${i}/playing`,d=`https://api.streamelements.com/kappa/v2/songrequest/${i}/queue/public`,c=`https://corsproxy.io/?https://ttvu.link/dashboard/commands/${a}`,m=async()=>fetch(c).then(e=>e.text()).then(e=>{let t=new DOMParser,a=t.parseFromString(e,"text/html"),n=a.querySelectorAll("tbody>tr"),s=[];return n.forEach(function(e){"Everyone"==e.querySelectorAll("td")[1].innerText&&s.push({command:e.querySelectorAll("td")[0].innerText.split("!")[1],description:e.querySelectorAll("td")[2].innerText})}),s}).catch(e=>(console.warn("Error while getting TTV Updates: ",e),[])),p=async()=>{try{let[e,t]=await Promise.all([fetch(l,{method:"GET",headers:{"Content-Type":"application/json"}}),fetch(o,{method:"GET",headers:{"Content-Type":"application/json"}}),]);e.ok&&t.ok||console.log("Not ok response");let[a,n]=await Promise.all([e.json(),t.json()]),s=[];for(let i of a)!0===i.enabled&&100===i.accessLevel&&s.push({command:i.command,description:i.reply});for(let r of n)!0===r.enabled&&100===r.accessLevel&&s.push({command:r.command,description:r.description});let d=s.filter((e,t,a)=>t===a.findIndex(t=>t.command===e.command)),c=[...d];return c.sort((e,t)=>e.command.localeCompare(t.command)),c}catch(m){return console.warn("Error while getting StreamElements Commands: ",m),[]}},u=async()=>{let e=await m(),t=await p();return t.concat(e)},y=async()=>{try{let[e,t]=await Promise.all([fetch(r,{method:"GET",headers:{"Content-Type":"application/json"}}).catch(e=>{throw e&&e.message&&e.message.includes("Failed to fetch")&&console.error("Failed to fetch StreamElementsSongsLink1"),e}),fetch(d,{method:"GET",headers:{"Content-Type":"application/json"}}).catch(e=>{throw e&&e.message&&e.message.includes("Failed to fetch")&&console.error("Failed to fetch StreamElementsSongsLink2"),e}),]);if(!e.ok||!t.ok)return console.error("Not ok response"),[];let[a,n]=await Promise.all([e.json(),t.json()]),s=[],i={};if(void 0!=a&&void 0!=a.title&&(i.title=void 0!=a.title?a.title:"Unknown title",i.videoId=void 0!=a.videoId?a.videoId:void 0,i.user=void 0!=a.user&&void 0!=a.user.username?a.user.username:"Unknown user",i.playing=!0,s.push(i)),void 0!=n&&n.length>0)for(let l of n){let o={};o.title=void 0!=l.title?l.title:"Unknown title",o.videoId=void 0!=l.videoId?l.videoId:void 0,o.user=void 0!=l.user.username&&void 0!=l.user.username?l.user.username:"Unknown user",s.push(o)}return s}catch(c){return"Unexpected end of JSON input"===c.message?console.info("%cUnexpected end of JSON: %cMost likely streamer hasn't enabled functionality","color: red; font-size: 2em;","font-size: 1.5em;"):console.warn("Error while getting streamer song queue: ",c),[]}};function g(e){"commands"===e?(document.getElementById("commands").classList.add("active"),document.getElementById("songs").classList.remove("active"),document.getElementById("list").style.display="block",document.getElementById("songsTab").style.display="none"):(document.getElementById("commands").classList.remove("active"),document.getElementById("songs").classList.add("active"),document.getElementById("list").style.display="none",document.getElementById("songsTab").style.display="block")}function h(e){navigator.clipboard.writeText("!"+e+" ")}chrome.tabs.query({active:!0,currentWindow:!0},function(e){if(chrome.runtime.lastError)console.error("Error: "+chrome.runtime.lastError.message);else{let t=e[0];chrome.scripting.executeScript({target:{tabId:t.id},function:()=>document.getElementsByTagName("html")[0].classList.contains("tw-root--theme-dark")}).then(e=>{let t=document.querySelector("body");e[0].result||(t.classList.replace("dark","light"),document.querySelectorAll("img").forEach(e=>{e.src="media/refresh.svg"}))})}}),document.getElementById("commands").addEventListener("click",async()=>{g("commands")}),document.getElementById("songs").addEventListener("click",async()=>{g("songs")});let E=document.getElementById("list"),v=document.getElementById("songsTab"),$=document.createElement("div"),f=document.createElement("div");async function w(e=""){$.innerText="",document.getElementsByClassName("cmd")[0].classList.add("loader");let t=await u();if(""!=e){let a=[];t.forEach(function(t){(t.command.includes(e)||t.description.includes(e))&&a.push(t)}),t=a}if(t.length>0)document.getElementsByClassName("cmd")[0].classList.remove("loader"),t.forEach(function(e){let t=document.createElement("div");t.classList.add("element");let a=document.createElement("div");a.classList.add("button"),a.textContent="!"+e.command;let n=document.createElement("p");n.textContent=e.description;let s=document.createElement("img");s.classList.add("copy","copy-img"),s.alt="Copy",s.addEventListener("click",()=>{h(e.command),s.classList.replace("copy-img","copied-img"),setTimeout(()=>s.classList.replace("copied-img","copy-img"),1500)}),a.appendChild(s),t.appendChild(a),t.appendChild(n),$.appendChild(t)});else{document.getElementsByClassName("cmd")[0].classList.remove("loader");let n=document.createElement("h3");n.textContent="No commands found.",$.appendChild(n)}}async function L(){f.innerText="",document.getElementsByClassName("song")[0].classList.add("loader");let e=await y();if(e.length>0)document.getElementsByClassName("song")[0].classList.remove("loader"),e.forEach(e=>{let t=document.createElement("div"),a=document.createElement("div");t.classList.add("element");let n=document.createElement("a"),s=document.createElement("p");n.innerText=e.title,!0===e.playing&&n.classList.add("playing"),s.textContent="Requesting user: "+e.user,s.style.clear="both";let i=document.createElement("img");if(i.classList.add("copy","copy-img"),i.addEventListener("click",()=>{navigator.clipboard.writeText("@"+e.user),i.classList.replace("copy-img","copied-img"),setTimeout(()=>i.classList.replace("copied-img","copy-img"),1500)}),s.appendChild(i),a.appendChild(n),t.appendChild(a),t.appendChild(s),f.appendChild(t),document.getElementById("songsTab").appendChild(f),void 0!=e.videoId){let l=document.createElement("img");l.classList.add("copy"),l.alt="Copy",l.classList.add("copy-img");let o=document.createElement("img");o.classList.add("open"),o.alt="Open in new page",o.classList.add("external"),n.appendChild(l),n.appendChild(o),o.addEventListener("click",()=>window.open("https://youtu.be/"+e.videoId,"_blank")),l.addEventListener("click",()=>{navigator.clipboard.writeText(e.title),l.classList.replace("copy-img","copied-img"),setTimeout(()=>{l.classList.replace("copied-img","copy-img")},1500)})}});else{document.getElementsByClassName("song")[0].classList.remove("loader");let t=document.createElement("h3");t.textContent="No songs found.",f.appendChild(t)}}$.style.width="100%",f.style.width="100%",E.appendChild($),v.append(f);let k="",C=document.getElementById("search");document.querySelector("#list .refresh").addEventListener("click",async()=>{await w()}),document.querySelector("#songsTab .refresh").addEventListener("click",async()=>{await L()}),C.addEventListener("input",async function(e){""===C.value.toLowerCase().trim()?(clearTimeout(t),t=setTimeout(async function(){await w()},300)):""===k&&"deleteContentBackward"===e.inputType?(clearTimeout(t),t=setTimeout(async function(){await w()},300)):(clearTimeout(t),t=setTimeout(async function(){await w(C.value.toLowerCase().trim())},300)),k=C.value.toLowerCase().trim()}),await w(),await L()});